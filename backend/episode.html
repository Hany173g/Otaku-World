<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>الحلقات</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }
    form { text-align: center; margin-bottom: 20px; }
    input, button { padding: 10px; font-size: 16px; border-radius: 5px; }
    input { width: 250px; border: 1px solid #ccc; }
    button { border: none; background: #007BFF; color: #fff; cursor: pointer; }
    button:hover { background: #0056b3; }
    .episode-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
    .episode-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .episode-card img { max-width: 100%; border-radius: 5px; margin-bottom: 10px; }
    .episode-card h3 { margin: 0 0 10px; }
    .episode-card p { margin: 5px 0; }
    .episode-card iframe { width: 100%; height: 200px; border: none; border-radius: 5px; }
  </style>
</head>
<body>

  <h1>البحث عن الحلقات</h1>

  <form id="searchForm">
    <input type="text" id="animeName" placeholder="اكتب اسم الأنمي..." required>
    <button type="submit">بحث</button>
  </form>

  <div id="episodes" class="episode-list"></div>

  <script>
    const form = document.getElementById("searchForm");
    const episodesContainer = document.getElementById("episodes");

    // تحويل رابط YouTube لرابط embed
    function convertYouTubeToEmbed(url) {
      if (!url) return "";
      const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/;
      const match = url.match(regex);
      return match ? `https://www.youtube.com/embed/${match[1]}` : url;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const animeName = document.getElementById("animeName").value.trim();
      if (!animeName) return;

      episodesContainer.innerHTML = "<p>جاري التحميل...</p>";

      try {
        const response = await fetch("http://localhost:3000/api/dashboard/getAllEpisode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionName: animeName })
        });

        if (!response.ok) throw new Error("HTTP error " + response.status);

        const result = await response.json();
        console.log(result);

        const episodes = result.data?.episodes || [];
        episodesContainer.innerHTML = "";

        if (episodes.length === 0) {
          episodesContainer.innerHTML = "<p>لا توجد نتائج.</p>";
          return;
        }

        episodes.forEach(ep => {
          const server = ep.servers?.[0]; // نعرض أول سيرفر فقط
          const videoSrc = convertYouTubeToEmbed(server?.videoUrl);
          const card = document.createElement("div");
          card.className = "episode-card";
          card.innerHTML = `
            <img src="${ep.Image || ''}" alt="صورة الحلقة">
            <h3>الحلقة ${ep.numberEpisode}</h3>
            <p><strong>الأنمي:</strong> ${result.data.sessionName}</p>
            <p><strong>السيرفر:</strong> ${server?.serverName || 'غير متوفر'}</p>
            <iframe src="${videoSrc}" allowfullscreen></iframe>
          `;
          episodesContainer.appendChild(card);
        });

      } catch (error) {
        console.error("Error loading episodes:", error);
        episodesContainer.innerHTML = "<p>حصل خطأ أثناء جلب البيانات.</p>";
      }
    });
  </script>

</body>
</html>
